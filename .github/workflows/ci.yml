name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-linux:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        compiler: [gcc-13, clang-18]
        build_type: [Release, Debug]

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: "pip"
        cache-dependency-path: python/pyproject.toml

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake ninja-build clang-18 gcc-13 g++-13 ccache \
          libeigen3-dev libboost-all-dev \
          libprotobuf-dev protobuf-compiler \
          libssl-dev libcurl4-openssl-dev \
          libintelrdfpmath-dev

    - name: Configure ccache
      run: |
        mkdir -p "$HOME/.ccache"
        ccache --set-config=cache_dir="$HOME/.ccache"

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-linux-${{ matrix.compiler }}-${{ matrix.build_type }}-${{ github.sha }}
        restore-keys: |
          ccache-linux-${{ matrix.compiler }}-${{ matrix.build_type }}-

    - name: Setup Python venv
      run: |
        python -m venv .venv
        . .venv/bin/activate
        pip install --upgrade pip
        pip install pybind11 numpy pandas pytest

    - name: Configure CMake
      run: |
        if [[ "${{ matrix.compiler }}" == "gcc-13" ]]; then
          export CC=gcc-13 CXX=g++-13
        else
          export CC=clang-18 CXX=clang++-18
        fi
        export CMAKE_PREFIX_PATH="${{ github.workspace }}/.venv"
        PYTHON_BIN="${{ github.workspace }}/.venv/bin/python"
        NUMPY_INC="$($PYTHON_BIN -c 'import numpy; print(numpy.get_include())')"
        PYBIND11_DIR="$($PYTHON_BIN -c 'import pybind11; print(pybind11.get_cmake_dir())')"
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
          -DBUILD_TESTS=ON \
          -DBUILD_PYTHON_BINDINGS=ON \
          -DREGIMEFLOW_FETCH_DEPS=ON \
          -DPython3_EXECUTABLE="$PYTHON_BIN" \
          -DPython3_NumPy_INCLUDE_DIRS="$NUMPY_INC" \
          -Dpybind11_DIR="$PYBIND11_DIR"

    - name: Build
      run: cmake --build build

    - name: Test
      run: cd build && ctest --output-on-failure

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: regimeflow-linux-${{ matrix.compiler }}
        path: build/lib/*.so

  build-macos:
    runs-on: macos-14
    strategy:
      matrix:
        build_type: [Release, Debug]
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: "pip"
        cache-dependency-path: python/pyproject.toml

    - name: Install dependencies
      run: |
        brew install cmake ninja eigen boost protobuf@21 ccache hiredis pkg-config
        brew link --force --overwrite protobuf@21
        python -m venv .venv
        . .venv/bin/activate
        python -m pip install --upgrade pip
        python -m pip install pybind11 numpy pandas pytest

    - name: Configure ccache
      run: |
        mkdir -p "$HOME/.ccache"
        ccache --set-config=cache_dir="$HOME/.ccache"

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-macos-${{ matrix.build_type }}-${{ github.sha }}
        restore-keys: |
          ccache-macos-${{ matrix.build_type }}-

    - name: Configure CMake
      run: |
        PYTHON_BIN="${{ github.workspace }}/.venv/bin/python"
        NUMPY_INC="$($PYTHON_BIN -c 'import numpy; print(numpy.get_include())')"
        PYBIND11_DIR="$($PYTHON_BIN -c 'import pybind11; print(pybind11.get_cmake_dir())')"
        cmake -B build -G Ninja \
          -DCMAKE_PREFIX_PATH="${{ github.workspace }}/.venv" \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
          -DBUILD_TESTS=ON \
          -DBUILD_PYTHON_BINDINGS=ON \
          -DREGIMEFLOW_FETCH_DEPS=ON \
          -DPython3_EXECUTABLE="$PYTHON_BIN" \
          -DPython3_NumPy_INCLUDE_DIRS="$NUMPY_INC" \
          -Dpybind11_DIR="$PYBIND11_DIR"

    - name: Build
      run: cmake --build build

    - name: Test
      run: cd build && ctest --output-on-failure

  build-windows:
    runs-on: windows-2022
    strategy:
      matrix:
        build_type: [Release, Debug]
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: "pip"
        cache-dependency-path: python/pyproject.toml

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install dependencies
      run: |
        choco install cmake ninja
        python -m venv .venv
        .venv\\Scripts\\python -m pip install --upgrade pip
        .venv\\Scripts\\python -m pip install pybind11 numpy pandas pytest

    - name: Install vcpkg packages
      run: |
        vcpkg install eigen3:x64-windows boost:x64-windows protobuf:x64-windows

    - name: Configure CMake
      run: |
        $python = "${{ github.workspace }}\.venv\Scripts\python.exe"
        $numpyInc = & $python -c "import numpy; print(numpy.get_include())"
        $pybind11Dir = & $python -c "import pybind11; print(pybind11.get_cmake_dir())"
        cmake -B build -G Ninja `
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} `
          -DCMAKE_PREFIX_PATH=${{ github.workspace }}\.venv `
          -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake `
          -DBUILD_TESTS=ON `
          -DBUILD_PYTHON_BINDINGS=ON `
          -DREGIMEFLOW_FETCH_DEPS=ON `
          -DPython3_EXECUTABLE=$python `
          -DPython3_NumPy_INCLUDE_DIRS=$numpyInc `
          -Dpybind11_DIR=$pybind11Dir

    - name: Build
      run: cmake --build build

    - name: Test
      run: cd build && ctest --output-on-failure

  python-tests:
    needs: build-linux
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: "pip"
        cache-dependency-path: python/pyproject.toml

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake ninja-build g++ \
          libeigen3-dev libboost-all-dev libprotobuf-dev protobuf-compiler \
          libintelrdfpmath-dev
        python -m venv .venv
        . .venv/bin/activate
        pip install --upgrade pip
        pip install build pytest numpy pandas

    - name: Build Python package
      run: |
        . .venv/bin/activate
        pip install -e "./python[dev]"

    - name: Run Python tests
      run: |
        . .venv/bin/activate
        pytest python/tests -v

  release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-macos, build-windows, python-tests]
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: "pip"
        cache-dependency-path: python/pyproject.toml

    - name: Download artifacts
      uses: actions/download-artifact@v4

    - name: Build Python wheels
      run: |
        python -m pip install --upgrade pip
        python -m pip install cibuildwheel
        cibuildwheel --platform linux
      env:
        CIBW_BEFORE_ALL_LINUX: >
          python -m pip install cmake &&
          if command -v yum >/dev/null 2>&1; then
            yum install -y protobuf-devel;
          elif command -v dnf >/dev/null 2>&1; then
            dnf install -y protobuf-devel;
          elif command -v apt-get >/dev/null 2>&1; then
            apt-get update && apt-get install -y libprotobuf-dev protobuf-compiler;
          else
            echo "No supported package manager found for protobuf" && exit 1;
          fi

    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          wheelhouse/*.whl
          regimeflow-linux-*/*.so
