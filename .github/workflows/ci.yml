name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  BUILD_TYPE: Release

jobs:
  build-linux:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        compiler: [gcc-11, clang-18]

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake ninja-build clang-18 gcc-11 g++-11 \
          libeigen3-dev libboost-all-dev \
          libprotobuf-dev protobuf-compiler \
          libssl-dev libcurl4-openssl-dev \
          python3-dev python3-pip python3-venv python3-numpy

    - name: Setup Python venv
      run: |
        python3 -m venv .venv
        . .venv/bin/activate
        pip install --upgrade pip
        pip install pybind11 numpy pandas pytest

    - name: Configure CMake
      run: |
        if [[ "${{ matrix.compiler }}" == "gcc-11" ]]; then
          export CC=gcc-11 CXX=g++-11
        else
          export CC=clang-18 CXX=clang++-18
        fi
        export CMAKE_PREFIX_PATH="${{ github.workspace }}/.venv"
        PYTHON_BIN="${{ github.workspace }}/.venv/bin/python"
        NUMPY_INC="$($PYTHON_BIN -c 'import numpy; print(numpy.get_include())')"
        PYBIND11_DIR="$($PYTHON_BIN -c 'import pybind11; print(pybind11.get_cmake_dir())')"
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DBUILD_TESTS=ON \
          -DBUILD_PYTHON_BINDINGS=ON \
          -DREGIMEFLOW_FETCH_DEPS=ON \
          -DPython3_EXECUTABLE="$PYTHON_BIN" \
          -DPython3_NumPy_INCLUDE_DIRS="$NUMPY_INC" \
          -Dpybind11_DIR="$PYBIND11_DIR"

    - name: Build
      run: cmake --build build

    - name: Test
      run: cd build && ctest --output-on-failure

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: regimeflow-linux-${{ matrix.compiler }}
        path: build/lib/*.so

  build-macos:
    runs-on: macos-14
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        brew install cmake ninja eigen boost protobuf
        python3 -m venv .venv
        . .venv/bin/activate
        pip install --upgrade pip
        pip install pybind11 numpy pandas pytest

    - name: Configure CMake
      run: |
        PYTHON_BIN="${{ github.workspace }}/.venv/bin/python"
        NUMPY_INC="$($PYTHON_BIN -c 'import numpy; print(numpy.get_include())')"
        PYBIND11_DIR="$($PYTHON_BIN -c 'import pybind11; print(pybind11.get_cmake_dir())')"
        cmake -B build -G Ninja \
          -DCMAKE_PREFIX_PATH="${{ github.workspace }}/.venv" \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DBUILD_TESTS=ON \
          -DBUILD_PYTHON_BINDINGS=ON \
          -DREGIMEFLOW_FETCH_DEPS=ON \
          -DPython3_EXECUTABLE="$PYTHON_BIN" \
          -DPython3_NumPy_INCLUDE_DIRS="$NUMPY_INC" \
          -Dpybind11_DIR="$PYBIND11_DIR"

    - name: Build
      run: cmake --build build

    - name: Test
      run: cd build && ctest --output-on-failure

  build-windows:
    runs-on: windows-2022
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install dependencies
      run: |
        choco install cmake ninja
        python -m venv .venv
        .venv\\Scripts\\pip install --upgrade pip
        .venv\\Scripts\\pip install pybind11 numpy pandas pytest

    - name: Install vcpkg packages
      run: |
        vcpkg install eigen3:x64-windows boost:x64-windows

    - name: Configure CMake
      run: |
        $python = "${{ github.workspace }}\.venv\Scripts\python.exe"
        $numpyInc = & $python -c "import numpy; print(numpy.get_include())"
        $pybind11Dir = & $python -c "import pybind11; print(pybind11.get_cmake_dir())"
        cmake -B build -G Ninja `
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
          -DCMAKE_PREFIX_PATH=${{ github.workspace }}\.venv `
          -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake `
          -DBUILD_TESTS=ON `
          -DBUILD_PYTHON_BINDINGS=ON `
          -DREGIMEFLOW_FETCH_DEPS=ON `
          -DPython3_EXECUTABLE=$python `
          -DPython3_NumPy_INCLUDE_DIRS=$numpyInc `
          -Dpybind11_DIR=$pybind11Dir

    - name: Build
      run: cmake --build build

    - name: Test
      run: cd build && ctest --output-on-failure

  python-tests:
    needs: build-linux
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libeigen3-dev libboost-all-dev libprotobuf-dev protobuf-compiler python3-venv
        python -m venv .venv
        . .venv/bin/activate
        pip install --upgrade pip
        pip install build pytest numpy pandas

    - name: Build Python package
      run: |
        . .venv/bin/activate
        pip install -e "./python[dev]"

    - name: Run Python tests
      run: |
        . .venv/bin/activate
        pytest python/tests -v

  release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-macos, build-windows, python-tests]
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Download artifacts
      uses: actions/download-artifact@v4

    - name: Build Python wheels
      run: |
        pip install cibuildwheel
        cibuildwheel --platform linux

    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          wheelhouse/*.whl
          regimeflow-linux-*/*.so
