name: CI

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Jobs to run (all, windows, linux, macos, python)"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - windows
          - linux
          - macos
          - python
      vcpkg_upgrade:
        description: "Run vcpkg upgrade step (windows only)"
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      single_test:
        description: "Optional gtest filter for Windows debug (leave empty to skip)"
        required: false
        default: ""
        type: string
      reuse_build:
        description: "Reuse last successful Windows build artifacts (skips build)"
        required: true
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      artifact_run_id:
        description: "Optional run ID to download build artifacts from (windows only)"
        required: false
        default: ""
        type: string
      collect_dump:
        description: "Collect a crash dump when Windows tests fail"
        required: true
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: read
  actions: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-linux:
    if: ${{ inputs.target == 'all' || inputs.target == 'linux' || inputs.target == 'python' }}
    runs-on: ubuntu-24.04
    env:
      VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/vcpkg-bincache
    strategy:
      matrix:
        compiler: [gcc-13, clang-18]
        build_type: [Release, Debug]

    steps:
    - uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871
      with:
        submodules: recursive

    - name: Set up Python
      if: ${{ inputs.reuse_build != 'true' }}
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
      with:
        python-version: "3.12"
        cache: "pip"
        cache-dependency-path: python/pyproject.toml

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake ninja-build clang-18 gcc-13 g++-13 ccache \
          libeigen3-dev libboost-all-dev \
          libprotobuf-dev protobuf-compiler \
          libssl-dev libcurl4-openssl-dev \
          libintelrdfpmath-dev

    - name: Configure ccache
      run: |
        mkdir -p "$HOME/.ccache"
        ccache --set-config=cache_dir="$HOME/.ccache"

    - name: Cache ccache
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684
      with:
        path: ~/.ccache
        key: ccache-linux-${{ matrix.compiler }}-${{ matrix.build_type }}-${{ github.sha }}
        restore-keys: |
          ccache-linux-${{ matrix.compiler }}-${{ matrix.build_type }}-

    - name: Cache vcpkg downloads and binaries
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684
      with:
        path: |
          vcpkg/archives
          vcpkg-bincache
        key: vcpkg-linux-${{ hashFiles('vcpkg.json') || 'novcpkg' }}-${{ github.sha }}
        restore-keys: |
          vcpkg-linux-${{ hashFiles('vcpkg.json') || 'novcpkg' }}-
          vcpkg-linux-

    - name: Setup Python venv
      run: |
        python -m venv .venv
        . .venv/bin/activate
        pip install --upgrade pip
        pip install pybind11 numpy pandas pytest

    - name: Configure CMake
      run: |
        if [[ "${{ matrix.compiler }}" == "gcc-13" ]]; then
          export CC=gcc-13 CXX=g++-13
        else
          export CC=clang-18 CXX=clang++-18
        fi
        export CMAKE_PREFIX_PATH="${{ github.workspace }}/.venv"
        PYTHON_BIN="${{ github.workspace }}/.venv/bin/python"
        NUMPY_INC="$($PYTHON_BIN -c 'import numpy; print(numpy.get_include())')"
        PYBIND11_DIR="$($PYTHON_BIN -c 'import pybind11; print(pybind11.get_cmake_dir())')"
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
          -DBUILD_TESTS=ON \
          -DBUILD_PYTHON_BINDINGS=ON \
          -DREGIMEFLOW_FETCH_DEPS=ON \
          -DPython3_EXECUTABLE="$PYTHON_BIN" \
          -DPython3_NumPy_INCLUDE_DIRS="$NUMPY_INC" \
          -Dpybind11_DIR="$PYBIND11_DIR"

    - name: Build
      run: cmake --build build

    - name: Test
      env:
        REGIMEFLOW_TEST_ROOT: ${{ github.workspace }}
      run: cd build && ctest --output-on-failure

    - name: Upload artifacts
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
      with:
        name: regimeflow-linux-${{ matrix.compiler }}-${{ matrix.build_type }}
        path: build/lib/*.so

  build-macos:
    if: ${{ inputs.target == 'all' || inputs.target == 'macos' }}
    runs-on: macos-14
    env:
      VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/vcpkg-bincache
    strategy:
      matrix:
        build_type: [Release, Debug]
    steps:
    - uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
      with:
        python-version: "3.12"
        cache: "pip"
        cache-dependency-path: python/pyproject.toml

    - name: Install dependencies
      run: |
        brew install cmake ninja eigen boost protobuf@21 ccache hiredis pkg-config
        brew link --force --overwrite protobuf@21
        python -m venv .venv
        . .venv/bin/activate
        python -m pip install --upgrade pip
        python -m pip install pybind11 numpy pandas pytest

    - name: Configure ccache
      run: |
        mkdir -p "$HOME/.ccache"
        ccache --set-config=cache_dir="$HOME/.ccache"

    - name: Cache ccache
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684
      with:
        path: ~/.ccache
        key: ccache-macos-${{ matrix.build_type }}-${{ github.sha }}
        restore-keys: |
          ccache-macos-${{ matrix.build_type }}-

    - name: Cache vcpkg downloads and binaries
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684
      with:
        path: |
          vcpkg/archives
          vcpkg-bincache
        key: vcpkg-macos-${{ hashFiles('vcpkg.json') || 'novcpkg' }}-${{ github.sha }}
        restore-keys: |
          vcpkg-macos-${{ hashFiles('vcpkg.json') || 'novcpkg' }}-
          vcpkg-macos-

    - name: Configure CMake
      run: |
        export PKG_CONFIG_PATH="/opt/homebrew/lib/pkgconfig:/opt/homebrew/share/pkgconfig"
        PYTHON_BIN="${{ github.workspace }}/.venv/bin/python"
        NUMPY_INC="$($PYTHON_BIN -c 'import numpy; print(numpy.get_include())')"
        PYBIND11_DIR="$($PYTHON_BIN -c 'import pybind11; print(pybind11.get_cmake_dir())')"
        cmake -B build -G Ninja \
          -DCMAKE_PREFIX_PATH="${{ github.workspace }}/.venv" \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
          -DBUILD_TESTS=ON \
          -DBUILD_PYTHON_BINDINGS=ON \
          -DREGIMEFLOW_FETCH_DEPS=ON \
          -DPython3_EXECUTABLE="$PYTHON_BIN" \
          -DPython3_NumPy_INCLUDE_DIRS="$NUMPY_INC" \
          -Dpybind11_DIR="$PYBIND11_DIR"

    - name: Build
      run: cmake --build build

    - name: Test
      env:
        REGIMEFLOW_TEST_ROOT: ${{ github.workspace }}
      run: cd build && ctest --output-on-failure

  build-windows-debug:
    if: ${{ inputs.target == 'all' || inputs.target == 'windows' }}
    runs-on: windows-2022
    env:
      VCPKG_ROOT: C:\vcpkg
      VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}\vcpkg-bincache
    steps:
    - uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
      with:
        python-version: "3.12"
        cache: "pip"
        cache-dependency-path: python/pyproject.toml

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@5c330b455f564f5da8d76ddd421de0e33f763f03

    - name: Install dependencies
      if: ${{ inputs.reuse_build != 'true' }}
      run: |
        choco install cmake ninja --yes --no-progress
        refreshenv
        python -m venv .venv
        .venv\\Scripts\\python -m pip install --upgrade pip
        .venv\\Scripts\\python -m pip install pybind11 numpy pandas pytest

    - name: Cache vcpkg downloads and binaries
      if: ${{ inputs.reuse_build != 'true' }}
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684
      with:
        path: |
          C:\vcpkg\archives
          ${{ github.workspace }}\vcpkg-bincache
          ${{ github.workspace }}\vcpkg_installed
        key: vcpkg-windows-${{ hashFiles('vcpkg.json') || 'novcpkg' }}-${{ github.sha }}
        restore-keys: |
          vcpkg-windows-${{ hashFiles('vcpkg.json') || 'novcpkg' }}-
          vcpkg-windows-

    - name: Install vcpkg packages
      if: ${{ inputs.reuse_build != 'true' }}
      run: |
        $ErrorActionPreference = "Stop"
        New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\vcpkg-bincache" | Out-Null
        for ($i = 1; $i -le 3; $i++) {
          try {
            vcpkg install --vcpkg-root C:\vcpkg --x-manifest-root "${{ github.workspace }}" --x-install-root "${{ github.workspace }}\\vcpkg_installed" --triplet x64-windows
            break
          } catch {
            if ($i -eq 3) { throw }
            Start-Sleep -Seconds (30 * $i)
          }
        }

    - name: Configure CMake
      if: ${{ inputs.reuse_build != 'true' }}
      run: |
        $python = "${{ github.workspace }}\.venv\Scripts\python.exe"
        $ninja = (Get-Command ninja).Source
        $numpyInc = & $python -c "import numpy; print(numpy.get_include())"
        $pybind11Dir = & $python -c "import pybind11; print(pybind11.get_cmake_dir())"
        $cmakeArgs = @(
          "-B", "build",
          "-G", "Ninja",
          "-DCMAKE_BUILD_TYPE=Debug",
          "-DCMAKE_PREFIX_PATH=${{ github.workspace }}\.venv",
          "-DCMAKE_TOOLCHAIN_FILE=C:\\vcpkg\\scripts\\buildsystems\\vcpkg.cmake",
          "-DVCPKG_INSTALLED_DIR=${{ github.workspace }}\\vcpkg_installed",
          "-DREGIMEFLOW_FETCH_DEPS=ON",
          "-DCMAKE_MAKE_PROGRAM=$ninja",
          "-DCMAKE_POLICY_VERSION_MINIMUM=3.5",
          "-DENABLE_POSTGRES=OFF",
          "-DBUILD_TESTS=ON",
          "-DBUILD_PYTHON_BINDINGS=ON",
          "-DPython3_EXECUTABLE=$python",
          "-DPython3_NumPy_INCLUDE_DIRS=$numpyInc",
          "-Dpybind11_DIR=$pybind11Dir"
        )
        Write-Host "CMake args: $($cmakeArgs -join ' ')"
        cmake @cmakeArgs

    - name: Build
      if: ${{ inputs.reuse_build != 'true' }}
      run: cmake --build build

    - name: Upload Windows build artifacts
      if: ${{ inputs.reuse_build != 'true' }}
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
      with:
        name: windows-build-Debug
        path: |
          build/**
          vcpkg_installed/x64-windows/bin/**
          vcpkg_installed/x64-windows/debug/bin/**

    - name: Download Windows build artifacts (latest successful)
      if: ${{ inputs.reuse_build == 'true' && inputs.artifact_run_id == '' }}
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: ci.yml
        branch: ${{ github.ref_name }}
        workflow_conclusion: success
        name: windows-build-Debug

    - name: Download Windows build artifacts (specific run)
      if: ${{ inputs.reuse_build == 'true' && inputs.artifact_run_id != '' }}
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: ci.yml
        run_id: ${{ inputs.artifact_run_id }}
        name: windows-build-Debug

    - name: Debug single test (Windows)
      if: ${{ inputs.single_test != '' && inputs.collect_dump != 'true' }}
      run: |
        $env:REGIMEFLOW_TEST_ROOT = "${{ github.workspace }}"
        $env:PATH = "${{ github.workspace }}\\build\\bin;${{ github.workspace }}\\build;${{ github.workspace }}\\vcpkg_installed\\x64-windows\\bin;${{ github.workspace }}\\vcpkg_installed\\x64-windows\\debug\\bin;$env:PATH"
        $outFile = "${{ github.workspace }}\\build\\single_test.log"
        Write-Host "Running single test: ${{ inputs.single_test }}"
        build\bin\regimeflow_tests.exe --gtest_filter=${{ inputs.single_test }} --gtest_break_on_failure --gtest_catch_exceptions=0 --gtest_color=no --gtest_print_time=1 2>&1 | Tee-Object -FilePath $outFile
        Write-Host "Single test exit code: $LASTEXITCODE"
        Write-Host "Single test log tail:"
        Get-Content $outFile -Tail 200

    - name: Windows tests with crash dump
      if: ${{ inputs.collect_dump == 'true' }}
      run: |
        $ErrorActionPreference = "Stop"
        $env:REGIMEFLOW_TEST_ROOT = "${{ github.workspace }}"
        $env:PATH = "${{ github.workspace }}\\build\\bin;${{ github.workspace }}\\build;${{ github.workspace }}\\vcpkg_installed\\x64-windows\\bin;${{ github.workspace }}\\vcpkg_installed\\x64-windows\\debug\\bin;$env:PATH"
        $dumpRoot = "${{ github.workspace }}\\crash_dumps"
        New-Item -ItemType Directory -Force -Path $dumpRoot | Out-Null
        $zip = "${{ github.workspace }}\\procdump.zip"
        $procDir = "${{ github.workspace }}\\procdump"
        Invoke-WebRequest -Uri "https://download.sysinternals.com/files/Procdump.zip" -OutFile $zip
        Expand-Archive -Path $zip -DestinationPath $procDir -Force
        $procdump = Join-Path $procDir "procdump.exe"
        Write-Host "Running regimeflow_tests with procdump..."
        $filterArg = ""
        if ("${{ inputs.single_test }}" -ne "") {
          $filterArg = "--gtest_filter=${{ inputs.single_test }}"
          Write-Host "Using gtest filter: $filterArg"
        }
        & $procdump -accepteula -e -ma -x $dumpRoot build\bin\regimeflow_tests.exe $filterArg --gtest_break_on_failure --gtest_catch_exceptions=0 --gtest_color=no --gtest_print_time=1
        Write-Host "Exit code: $LASTEXITCODE"

    - name: Test
      if: ${{ inputs.single_test == '' && inputs.collect_dump != 'true' }}
      env:
        REGIMEFLOW_TEST_ROOT: ${{ github.workspace }}
      run: cd build && ctest --output-on-failure

    - name: Upload crash dumps
      if: ${{ inputs.collect_dump == 'true' && always() }}
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
      with:
        name: windows-crash-dumps-Debug
        path: crash_dumps/**

  build-windows-release:
    if: ${{ (inputs.target == 'all' || inputs.target == 'windows') && inputs.reuse_build != 'true' && inputs.collect_dump != 'true' && inputs.single_test == '' }}
    runs-on: windows-2022
    env:
      VCPKG_ROOT: C:\vcpkg
      VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}\vcpkg-bincache
    steps:
    - uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
      with:
        python-version: "3.12"
        cache: "pip"
        cache-dependency-path: python/pyproject.toml

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@5c330b455f564f5da8d76ddd421de0e33f763f03

    - name: Install dependencies
      run: |
        choco install cmake ninja --yes --no-progress
        refreshenv
        python -m venv .venv
        .venv\\Scripts\\python -m pip install --upgrade pip
        .venv\\Scripts\\python -m pip install pybind11 numpy pandas pytest

    - name: Cache vcpkg downloads and binaries
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684
      with:
        path: |
          C:\vcpkg\archives
          ${{ github.workspace }}\vcpkg-bincache
          ${{ github.workspace }}\vcpkg_installed
        key: vcpkg-windows-${{ hashFiles('vcpkg.json') || 'novcpkg' }}-${{ github.sha }}
        restore-keys: |
          vcpkg-windows-${{ hashFiles('vcpkg.json') || 'novcpkg' }}-
          vcpkg-windows-

    - name: Install vcpkg packages
      run: |
        $ErrorActionPreference = "Stop"
        New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\vcpkg-bincache" | Out-Null
        for ($i = 1; $i -le 3; $i++) {
          try {
            vcpkg install --vcpkg-root C:\vcpkg --x-manifest-root "${{ github.workspace }}" --x-install-root "${{ github.workspace }}\\vcpkg_installed" --triplet x64-windows
            break
          } catch {
            if ($i -eq 3) { throw }
            Start-Sleep -Seconds (30 * $i)
          }
        }

    - name: Configure CMake
      run: |
        $python = "${{ github.workspace }}\.venv\Scripts\python.exe"
        $ninja = (Get-Command ninja).Source
        $numpyInc = & $python -c "import numpy; print(numpy.get_include())"
        $pybind11Dir = & $python -c "import pybind11; print(pybind11.get_cmake_dir())"
        $cmakeArgs = @(
          "-B", "build",
          "-G", "Ninja",
          "-DCMAKE_BUILD_TYPE=Release",
          "-DCMAKE_PREFIX_PATH=${{ github.workspace }}\.venv",
          "-DCMAKE_TOOLCHAIN_FILE=C:\\vcpkg\\scripts\\buildsystems\\vcpkg.cmake",
          "-DVCPKG_INSTALLED_DIR=${{ github.workspace }}\\vcpkg_installed",
          "-DREGIMEFLOW_FETCH_DEPS=ON",
          "-DCMAKE_MAKE_PROGRAM=$ninja",
          "-DCMAKE_POLICY_VERSION_MINIMUM=3.5",
          "-DENABLE_POSTGRES=OFF",
          "-DBUILD_TESTS=ON",
          "-DBUILD_PYTHON_BINDINGS=ON",
          "-DPython3_EXECUTABLE=$python",
          "-DPython3_NumPy_INCLUDE_DIRS=$numpyInc",
          "-Dpybind11_DIR=$pybind11Dir"
        )
        Write-Host "CMake args: $($cmakeArgs -join ' ')"
        cmake @cmakeArgs

    - name: Build
      run: cmake --build build

    - name: Upload Windows build artifacts
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
      with:
        name: windows-build-Release
        path: |
          build/**
          vcpkg_installed/x64-windows/bin/**
          vcpkg_installed/x64-windows/debug/bin/**

    - name: Test
      env:
        REGIMEFLOW_TEST_ROOT: ${{ github.workspace }}
      run: cd build && ctest --output-on-failure

  python-tests:
    if: ${{ inputs.target == 'all' || inputs.target == 'python' }}
    needs: build-linux
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
      with:
        python-version: ${{ matrix.python-version }}
        cache: "pip"
        cache-dependency-path: python/pyproject.toml

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake ninja-build g++ \
          libeigen3-dev libboost-all-dev libprotobuf-dev protobuf-compiler \
          libintelrdfpmath-dev
        python -m venv .venv
        . .venv/bin/activate
        pip install --upgrade pip
        pip install build pytest numpy pandas pybind11

    - name: Build Python package
      run: |
        . .venv/bin/activate
        PYTHON_BIN="$(pwd)/.venv/bin/python"
        NUMPY_INC="$($PYTHON_BIN -c 'import numpy; print(numpy.get_include())')"
        PYBIND11_DIR="$($PYTHON_BIN -c 'import pybind11; print(pybind11.get_cmake_dir())')"
        pip install -e "./python[dev]" \
          --config-settings=cmake.define.Python3_EXECUTABLE="$PYTHON_BIN" \
          --config-settings=cmake.define.Python3_NumPy_INCLUDE_DIRS="$NUMPY_INC" \
          --config-settings=cmake.define.pybind11_DIR="$PYBIND11_DIR"

    - name: Run Python tests
      env:
        REGIMEFLOW_TEST_ROOT: ${{ github.workspace }}
      run: |
        . .venv/bin/activate
        pytest python/tests -v

  release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-macos, build-windows, python-tests]
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
      with:
        python-version: "3.12"
        cache: "pip"
        cache-dependency-path: python/pyproject.toml

    - name: Download artifacts
      uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e

    - name: Build Python wheels
      run: |
        python -m pip install --upgrade pip
        python -m pip install cibuildwheel
        cibuildwheel --platform linux
      env:
        CIBW_BEFORE_ALL_LINUX: >
          python -m pip install cmake &&
          if command -v yum >/dev/null 2>&1; then
            yum install -y protobuf-devel;
          elif command -v dnf >/dev/null 2>&1; then
            dnf install -y protobuf-devel;
          elif command -v apt-get >/dev/null 2>&1; then
            apt-get update && apt-get install -y libprotobuf-dev protobuf-compiler;
          else
            echo "No supported package manager found for protobuf" && exit 1;
          fi

    - name: Create release
      uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
      with:
        files: |
          wheelhouse/*.whl
          regimeflow-linux-*/*.so
